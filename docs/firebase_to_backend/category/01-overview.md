# 카테고리 기능 개요

## 📋 카테고리란?

카테고리는 SOI 앱의 핵심 기능으로, **사용자들이 사진을 공유하는 그룹**입니다.

### 주요 특징

- **프라이빗 공유**: 초대된 멤버들만 사진을 볼 수 있음
- **실시간 동기화**: 새로운 사진이 업로드되면 모든 멤버가 확인 가능
- **음성 메모**: 각 사진에 음성 메모 첨부 가능
- **친구 기반**: 친구 관계가 있는 사용자들만 카테고리 생성/참여 가능

---

## 🎯 주요 사용 시나리오

### 시나리오 1: 카테고리 생성

```
1. 사용자 A가 "가족 여행" 카테고리 생성
2. 멤버로 친구 B, C 추가
3. B, C가 모두 A의 친구이면 즉시 카테고리 생성
4. B 또는 C가 서로 친구가 아니면 초대 대기 상태
```

### 시나리오 2: 멤버 추가

```
1. 기존 카테고리에 사용자 D 추가 요청
2. 요청자와 D의 친구 관계 확인
3. D와 기존 멤버들의 친구 관계 확인
4-1. 모두 친구이면 즉시 추가
4-2. 일부가 친구가 아니면 초대 대기
```

### 시나리오 3: 초대 수락

```
1. 사용자 D가 초대 알림 수신
2. 초대 정보 확인 (Pending 멤버 목록 포함)
3. 초대 수락
4. Pending 멤버들과 친구 추가 후 카테고리 접근 가능
5. 초대 삭제
```

### 시나리오 4: 사진 공유

```
1. 카테고리 멤버가 사진 업로드
2. 최신 사진 정보 업데이트 (업로더, 시간)
3. 다른 멤버들에게 알림 전송
4. 차단한 사용자의 사진은 표시하지 않음
```

---

## 🏗️ 카테고리 구조

### 카테고리 속성

```json
{
  "id": "category_123",
  "name": "가족 여행",
  "mates": ["user_a", "user_b", "user_c"],
  "createdAt": "2025-01-01T10:00:00Z",
  "categoryPhotoUrl": "https://...",
  "customNames": {
    "user_a": "우리 가족"
  },
  "userPinnedStatus": {
    "user_a": true
  },
  "lastPhotoUploadedBy": "user_b",
  "lastPhotoUploadedAt": "2025-01-10T15:30:00Z",
  "userLastViewedAt": {
    "user_a": "2025-01-10T14:00:00Z"
  }
}
```

### 멤버 관계

- **mates 배열**: 카테고리에 속한 모든 사용자 ID
- **최소 인원**: 1명 (자기 자신만 포함 가능)
- **최대 인원**: 제한 없음 (현재 구현)
- **권한**: 모든 멤버가 동등한 권한 (사진 추가/삭제, 멤버 추가 가능)

---

## 🔐 보안 및 권한

### 친구 관계 확인

카테고리 생성 및 멤버 추가 시 반드시 친구 관계 확인:

```
- 요청자 ←→ 대상 사용자: 양방향 친구 필수
- 기존 멤버 ←→ 신규 멤버: 양방향 친구 권장 (아니면 초대 대기)
```

### 차단 처리

- 1:1 카테고리에서 상대방을 차단한 경우 → 카테고리 목록에서 숨김
- 차단한 사용자의 사진 → 표시하지 않음

### 접근 권한

- **카테고리 조회**: 멤버만 가능
- **사진 업로드**: 멤버만 가능
- **멤버 추가**: 멤버만 가능
- **카테고리 삭제**: 모든 멤버 가능 (마지막 멤버 나갈 때 자동 삭제)

---

## 📊 카테고리 상태

### 일반 상태

- **Active**: 정상적으로 사용 중인 카테고리
- **Empty**: 멤버가 없는 카테고리 (자동 삭제)

### 사용자별 상태

- **isPinned**: 사용자가 고정한 카테고리 (목록 상단 표시)
- **hasNewPhoto**: 마지막 확인 이후 새로운 사진이 있는지 여부
- **customName**: 사용자별 커스텀 카테고리 이름

### 초대 상태

- **Pending**: 수락 대기 중
- **Accepted**: 수락됨
- **Declined**: 거절됨
- **Expired**: 만료됨

---

## 🔄 데이터 흐름

### 카테고리 생성 흐름

```
1. 검증
   - 카테고리 이름 (1-20자)
   - 멤버 최소 1명
   - 생성자가 멤버에 포함되었는지

2. 친구 관계 확인
   - 생성자 ←→ 각 멤버
   - 멤버들 간 상호 친구 관계

3. 카테고리 생성
   - Firestore에 문서 생성
   - ID 자동 생성

4. 초대 처리
   - 각 멤버별 Pending 멤버 확인
   - Pending 있으면 초대 생성
   - 알림 전송

5. 응답
   - 생성된 카테고리 ID 반환
```

### 사진 업로드 흐름

```
1. 검증
   - 카테고리 멤버 확인
   - 파일 형식/크기 확인

2. 파일 업로드
   - Firebase Storage에 저장
   - URL 생성

3. 데이터 저장
   - 사진 정보 Firestore에 저장
   - 카테고리 최신 사진 정보 업데이트

4. 알림
   - 다른 멤버들에게 알림 전송

5. 표지사진 업데이트 (선택적)
   - 첫 번째 사진이면 자동으로 표지사진 설정
```

---

## 📱 Flutter에서의 현재 구현

### 컨트롤러

- `CategoryController`: 카테고리 CRUD 및 상태 관리
- `CategoryMemberController`: 멤버 추가/제거
- `CategoryCoverPhotoController`: 표지사진 관리
- `CategorySearchController`: 검색 및 필터링

### 서비스

- `CategoryService`: 핵심 비즈니스 로직
- `CategoryMemberService`: 멤버 관리 로직
- `CategoryInviteService`: 초대 시스템 로직
- `CategoryPhotoService`: 사진 관리 로직

### Repository

- `CategoryRepository`: Firestore 직접 접근
- `CategoryInviteRepository`: 초대 컬렉션 접근

---

## 🎯 백엔드 이관 시 고려사항

### 1. 실시간 업데이트 대체

**현재**: Firestore Stream으로 실시간 업데이트
**변경**:

- Pull-to-refresh (수동 새로고침)
- FCM Push 알림
- 주기적 폴링 (선택적)

### 2. 친구 관계 확인 최적화

**현재**: 각 친구 관계를 개별 확인
**개선**:

- 배치 확인 API (여러 사용자 한 번에)
- JOIN 쿼리로 효율적 확인

### 3. 차단 필터링

**현재**: 클라이언트에서 필터링
**변경**: 백엔드에서 SQL 쿼리로 필터링

### 4. 트랜잭션 처리

**현재**: Firestore 트랜잭션 제한적
**개선**: ACID 트랜잭션 보장

- 카테고리 생성 + 초대 생성 (원자성)
- 멤버 제거 + 카테고리 삭제 (마지막 멤버)

---

## 📈 성능 메트릭

### 현재 Firebase 기준

- 카테고리 목록 조회: ~500ms (20개 카테고리)
- 카테고리 생성: ~1300ms (멤버 3명, 친구 확인 포함)
- 사진 업로드: ~2000ms (이미지 압축 + 업로드)

### 목표 (Spring Boot)

- 카테고리 목록 조회: ~100ms (JOIN 최적화)
- 카테고리 생성: ~200ms (배치 친구 확인)
- 사진 업로드: ~500ms (백엔드에서 처리)

---

## 다음 문서

👉 **[비즈니스 규칙](./02-business-rules.md)** - 모든 검증 및 비즈니스 로직 상세
