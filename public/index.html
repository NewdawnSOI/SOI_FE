<!-- public/invite.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SOI 초대</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .soi-logo { width: 120px; margin-bottom: 30px; }
        .invite-message { font-size: 18px; margin-bottom: 30px; }
        .download-btn { 
            background: #1976d2; color: white; padding: 15px 30px; 
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
        }
    </style>
</head>
<body>
    <img src="/assets/SOI_logo.png" alt="SOI" class="soi-logo">
    <div id="inviteMessage" class="invite-message">
        SOI 앱에서 친구 요청이 왔어요!
    </div>
    <button id="downloadBtn" class="download-btn">앱 다운로드</button>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const inviterName = urlParams.get('inviter') || '친구';
        const inviterId = urlParams.get('inviterId');
        const inviteeName = urlParams.get('invitee');
        
        // 메시지 개인화
        document.getElementById('inviteMessage').textContent = 
            `${inviterName}님이 SOI에서 친구 요청을 보냈어요!`;
        
        // 플랫폼별 다운로드
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        // 🔥 앱 설치 감지 강화 함수
        function tryOpenApp(deepLinkUrl, storeUrl) {
            let appOpened = false;
            const startTime = Date.now();
            
            // Page visibility 변화 감지
            const handleVisibilityChange = () => {
                if (document.hidden) {
                    appOpened = true;
                    console.log('✅ 앱이 열렸습니다');
                }
            };
            
            // Page focus 변화 감지 (추가 확인)
            const handleFocusChange = () => {
                if (!document.hasFocus()) {
                    appOpened = true;
                    console.log('✅ 앱으로 전환되었습니다');
                }
            };
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleFocusChange);
            
            // 딥링크 시도
            console.log(`🔗 딥링크 시도: ${deepLinkUrl}`);
            window.location.href = deepLinkUrl;
            
            // 2초 후 앱이 열리지 않았으면 스토어로 이동
            setTimeout(() => {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                window.removeEventListener('blur', handleFocusChange);
                
                if (!appOpened) {
                    console.log('❌ 앱이 설치되지 않음 - 스토어로 이동');
                    window.location.href = storeUrl;
                }
            }, 2000);
        }
        
        document.getElementById('downloadBtn').onclick = function() {
            const deepLinkData = `?inviter=${inviterName}&inviterId=${inviterId}&invitee=${inviteeName}`;
            
            if (isAndroid) {
                // Android: Intent URL로 앱 호출 시도
                const intentUrl = `intent://invite${deepLinkData}#Intent;scheme=soi;package=com.soi.app;S.browser_fallback_url=https://play.google.com/store/apps/details?id=com.soi.app;end`;
                const playStoreUrl = 'https://play.google.com/store/apps/details?id=com.soi.app';
                
                tryOpenApp(intentUrl, playStoreUrl);
            } else if (isIOS) {
                // iOS: Custom URL Scheme 시도
                const deepLinkUrl = `soi://invite${deepLinkData}`;
                const appStoreUrl = 'https://apps.apple.com/app/soi/id여기에앱ID';
                
                tryOpenApp(deepLinkUrl, appStoreUrl);
            } else {
                // 웹: 플레이스토어로
                window.location.href = 'https://play.google.com/store/apps/details?id=com.soi.app';
            }
        };
        
        // 🚀 페이지 로드 시 자동으로 앱 열기 시도 (선택사항)
        window.addEventListener('load', () => {
            // 3초 후 자동으로 앱 열기 시도
            setTimeout(() => {
                document.getElementById('downloadBtn').click();
            }, 1000);
        });
    </script>
</body>
</html>